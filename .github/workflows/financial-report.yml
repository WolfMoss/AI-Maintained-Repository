name: ğŸ“Š Daily Financial Report Automation

on:
  # â° å®šæ—¶è§¦å‘ - æ¯å¤©æ—©ä¸Š9:00 (UTC 1:00ï¼Œå› ä¸ºä¸­å›½æ—¶åŒºæ˜¯UTC+8)
  schedule:
    - cron: '0 1 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      mode:
        description: 'æ‰§è¡Œæ¨¡å¼'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - collect_only
          - report_only
      markets:
        description: 'è¦åˆ†æçš„å¸‚åœº'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - gold
          - stocks_usa
          - stocks_cn
      commit:
        description: 'æ˜¯å¦æäº¤åˆ°GitHub'
        required: true
        default: 'true'
        type: boolean
  
  # å½“financial_reportç›®å½•æœ‰æ›´æ–°æ—¶è§¦å‘
  push:
    branches: [main]
    paths:
      - 'financial_report/**'
      - '.github/workflows/financial-report.yml'
    branches-ignore: []

env:
  REPO_NAME: ${{ github.repository }}
  BRANCH_NAME: ${{ github.ref_name }}
  PYTHON_VERSION: '3.11'
  # è®¾ç½®æ—¶åŒºä¸ºä¸­å›½æ—¶åŒº
  TZ: Asia/Shanghai

jobs:
  # ==================== å®šæ—¶æŠ¥å‘Šä»»åŠ¡ ====================
  scheduled-financial-report:
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'full')
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'financial_report/requirements.txt'
      
      - name: Setup Timezone
        run: |
          sudo ln -snf /usr/share/zoneinfo/${{ env.TZ }} /etc/localtime
          echo "${{ env.TZ }}" | sudo tee /etc/timezone
          echo "TZ=Asia/Shanghai" >> $GITHUB_ENV
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests --quiet
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
      
      - name: ğŸ“Š Run Financial Report Generator
        id: run_report
        run: |
          echo "========================================"
          echo "ğŸ¦ é‡‘èåˆ†ææŠ¥å‘Šè‡ªåŠ¨ç”Ÿæˆå™¨"
          echo "ğŸ¤– AIé©±åŠ¨ - æ¯æ—¥å®šæ—¶æ‰§è¡Œ"
          echo "========================================"
          echo ""
          echo "ğŸ“… æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo ""
          
          cd financial_report
          python main.py --mode=auto --no-commit
          
          echo "âœ… æŠ¥å‘Šç”Ÿæˆå®Œæˆ"
      
      - name: ğŸ“‹ List Generated Reports
        run: |
          echo ""
          echo "ğŸ“Š ç”Ÿæˆçš„åˆ†ææŠ¥å‘Š:"
          ls -lh financial_report/reports/*.md 2>/dev/null || echo "æš‚æ— æŠ¥å‘Šæ–‡ä»¶"
      
      - name: ğŸ’¾ Commit and Push Changes
        if: github.event_name == 'schedule'
        run: |
          cd ${{ github.workspace }}
          
          # é…ç½®Git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ–‡ä»¶
          if git status --porcelain | grep -q .; then
            echo "ğŸ“¦ å‘ç°æ›´æ–°ï¼Œå‡†å¤‡æäº¤..."
            
            # æ·»åŠ æ‰€æœ‰æ›´æ”¹
            git add -A
            
            # åˆ›å»ºæäº¤
            commit_msg="ğŸ“Š é‡‘èåˆ†ææŠ¥å‘Šæ›´æ–° - $(date '+%Y-%m-%d %H:%M') ğŸ‡¨ğŸ‡³ğŸ‡ºğŸ‡¸ğŸ¥‡"
            git commit -m "$commit_msg" || echo "æ— éœ€æäº¤ï¼ˆæ— æ›´æ”¹ï¼‰"
            
            # æ¨é€åˆ°è¿œç¨‹
            git push origin ${{ env.BRANCH_NAME }} || echo "æ¨é€å¤±è´¥ï¼ˆå¯èƒ½æ— æ›´æ”¹ï¼‰"
            
            echo "âœ… å·²æäº¤å¹¶æ¨é€æ›´æ–°"
          else
            echo "â„¹ï¸ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          fi
      
      - name: ğŸ“Š Upload Report as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: financial-report-${{ github.run_id }}
          path: financial_report/reports/
          retention-days: 7
          compression-level: 9
      
      - name: ğŸ’¬ Send Completion Notification
        run: |
          echo ""
          echo "========================================"
          echo "âœ… é‡‘èåˆ†ææŠ¥å‘Šä»»åŠ¡å®Œæˆï¼"
          echo "ğŸ“… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "========================================"

  # ==================== ä»…æ”¶é›†æ•°æ®ä»»åŠ¡ ====================
  collect-data-only:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'collect_only'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Collect Data Only
        run: |
          echo "ğŸ“Š ä»…æ”¶é›†é‡‘èå¸‚åœºæ•°æ®..."
          cd financial_report
          python main.py --mode=manual --collect-only --no-commit
          
      - name: Commit Collected Data
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git status --porcelain | grep -q .; then
            git add -A
            git commit -m "ğŸ“ˆ å¸‚åœºæ•°æ®æ”¶é›† - $(date '+%Y-%m-%d %H:%M')" || true
            git push origin ${{ env.BRANCH_NAME }} || true
            echo "âœ… æ•°æ®å·²æäº¤"
          fi

  # ==================== ä»…ç”ŸæˆæŠ¥å‘Šä»»åŠ¡ ====================
  generate-report-only:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'report_only'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Generate Report Only
        run: |
          echo "ğŸ“ ä»…ç”Ÿæˆåˆ†ææŠ¥å‘Š..."
          cd financial_report
          python main.py --mode=report --no-commit
      
      - name: Commit Generated Report
        if: github.event.inputs.commit == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git status --porcelain | grep -q .; then
            git add -A
            git commit -m "ğŸ“Š åˆ†ææŠ¥å‘Šç”Ÿæˆ - $(date '+%Y-%m-%d %H:%M')" || true
            git push origin ${{ env.BRANCH_NAME }} || true
            echo "âœ… æŠ¥å‘Šå·²æäº¤"
          fi
      
      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: financial-report-manual-${{ github.run_id }}
          path: financial_report/reports/
          retention-days: 30

  # ==================== å¸‚åœºæ•°æ®åˆ†æä»»åŠ¡ ====================
  market-analysis:
    needs: scheduled-financial-report
    if: always() && needs.scheduled-financial-report.result == 'success'
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
      - name: Download Report
        uses: actions/download-artifact@v4
        with:
          name: financial-report-${{ github.run_id }}
          path: ./reports
      
      - name: Analyze Market Trends
        run: |
          echo "ğŸ“Š å¸‚åœºè¶‹åŠ¿åˆ†ææ‘˜è¦"
          echo "===================="
          echo ""
          
          # æ£€æŸ¥æœ€æ–°æŠ¥å‘Š
          latest_report=$(ls -t reports/*.md 2>/dev/null | head -1)
          
          if [ -f "$latest_report" ]; then
            echo "ğŸ“„ æœ€æ–°æŠ¥å‘Š: $latest_report"
            echo ""
            
            # æå–å…³é”®æŒ‡æ ‡ï¼ˆä½¿ç”¨ç®€å•çš„grepï¼‰
            echo "ğŸ“ˆ æŠ¥å‘Šæ¦‚è§ˆ:"
            grep -A2 "## " "$latest_report" | head -20 || echo "æ— æ³•è§£ææŠ¥å‘Š"
            
            echo ""
            echo "âœ… åˆ†æå®Œæˆ"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°æŠ¥å‘Šæ–‡ä»¶"
          fi
      
      - name: Generate Market Summary
        run: |
          cat << 'EOF'
          ğŸ“Š å¸‚åœºåˆ†ææ‰§è¡ŒæŠ¥å‘Š
          ==================
          
          æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')
          
          åˆ†æå†…å®¹:
          âœ… é»„é‡‘å¸‚åœºåˆ†æ
          âœ… ç¾è‚¡å¸‚åœºåˆ†æ  
          âœ… Aè‚¡å¸‚åœºåˆ†æ
          âœ… è·¨å¸‚åœºå¯¹æ¯”
          âœ… é£é™©è¯„ä¼°
          
          çŠ¶æ€: å·²å®Œæˆ
          EOF

  # ==================== æ•°æ®è´¨é‡æ£€æŸ¥ä»»åŠ¡ ====================
  data-quality-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Check Data Freshness
        run: |
          echo "ğŸ” æ•°æ®æ–°é²œåº¦æ£€æŸ¥"
          echo "================="
          echo ""
          
          # æ£€æŸ¥å„å¸‚åœºæ•°æ®
          for market in gold stocks_usa stocks_cn; do
            data_file="financial_report/data/${market}/latest_${market}_data.json"
            if [ -f "$data_file" ]; then
              last_modified=$(stat -c %y "$data_file" 2>/dev/null || stat -f %m "$data_file" 2>/dev/null)
              echo "âœ… $market: æœ€æ–° ($last_modified)"
            else
              echo "âš ï¸ $market: æ•°æ®ä¸å­˜åœ¨"
            fi
          done
          
          echo ""
          echo "âœ… æ•°æ®æ£€æŸ¥å®Œæˆ"

  # ==================== é€šçŸ¥ä»»åŠ¡ ====================
  notification:
    needs: [scheduled-financial-report, market-analysis]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Send Notification
        run: |
          echo "========================================"
          echo "ğŸ“Š é‡‘èåˆ†ææŠ¥å‘Šå·¥ä½œæµæ‰§è¡Œç»“æœ"
          echo "========================================"
          echo ""
          echo "ğŸ¦ æŠ¥å‘Šç”Ÿæˆ: ${{ needs.scheduled-financial-report.result }}"
          echo "ğŸ“ˆ è¶‹åŠ¿åˆ†æ: ${{ needs.market-analysis.result }}"
          echo ""
          
          if [[ "${{ needs.scheduled-financial-report.result }}" == "success" ]]; then
            echo "âœ… å…¨éƒ¨ä»»åŠ¡æˆåŠŸå®Œæˆï¼"
            echo "ğŸ“„ è¯·æŸ¥çœ‹ç”Ÿæˆçš„é‡‘èåˆ†ææŠ¥å‘Š"
          else
            echo "âš ï¸ éƒ¨åˆ†ä»»åŠ¡å¯èƒ½éœ€è¦äººå·¥æ£€æŸ¥"
          fi
          
          echo ""
          echo "ğŸ“… æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ğŸ”— GitHub Actions: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
